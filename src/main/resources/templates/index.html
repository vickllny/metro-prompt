<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
	<head>
	    <meta charset="UTF-8"/>
	    <link rel="stylesheet" href="/layui/css/layui.css">
	    <title></title>
	</head>
	<body>
		<div class="layui-tab layui-tab-card">
		  <ul class="layui-tab-title">
		    <li class="layui-this">首页</li>
		    <li>导入数据</li>
		  </ul>
		  <div class="layui-tab-content" style="height: 600px;">
		    <div class="layui-tab-item layui-show">
		    
		    </div>
		    <div class="layui-tab-item">
				<table class="layui-hide" id="test" lay-filter="test"></table>
				 
				<script type="text/html" id="toolbarDemo">
  					<div class="layui-btn-container">
    					<button class="layui-btn layui-btn-normal" id="uploadFile">导入</button>
  					</div>
				</script>
				 
				<script type="text/html" id="barDemo">
  					<a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
 					<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
				</script>
		    </div>
		  </div>
		</div>
		<div id="import-list" style="display: none">
			aaa
		</div>
	</body>
    <script type="text/javascript" src="/layui/layui.js"></script>
    <script type="text/javascript" src="/js-xlsx/xlsx.core.min.js"></script>
    <script type="text/javascript" src="/jquery/jquery.min.js"></script>
    <script>
		window.importListJson = []
		layui.use(['table', 'upload'], function(){
		  var table = layui.table;
		  let upload = layui.upload
		  table.render({
		    elem: '#test',
		    data: []
		    ,toolbar: '#toolbarDemo' //开启头部工具栏，并为其绑定左侧模板
		    ,defaultToolbar: ['filter', 'exports', 'print', { //自定义头部工具栏右侧图标。如无需自定义，去除该参数即可
		      title: '提示'
		      ,layEvent: 'LAYTABLE_TIPS'
		      ,icon: 'layui-icon-tips'
		    }]
		    ,title: '用户数据表'
		    ,cols: [[
		      {type: 'checkbox', fixed: 'left'}
		      ,{field:'id', title:'ID', width:80, fixed: 'left', unresize: true, sort: true}
		      ,{field:'username', title:'用户名', width:120, edit: 'text'}
		      ,{field:'email', title:'邮箱', width:150, edit: 'text', templet: function(res){
		        return '<em>'+ res.email +'</em>'
		      }}
		      ,{field:'sex', title:'性别', width:80, edit: 'text', sort: true}
		      ,{field:'city', title:'城市', width:100}
		      ,{field:'sign', title:'签名'}
		      ,{field:'experience', title:'积分', width:80, sort: true}
		      ,{field:'ip', title:'IP', width:120}
		      ,{field:'logins', title:'登入次数', width:100, sort: true}
		      ,{field:'joinTime', title:'加入时间', width:120}
		      ,{fixed: 'right', title:'操作', toolbar: '#barDemo', width:150}
		    ]]
		    ,page: true
		  });
		  
		  //头工具栏事件
		  table.on('toolbar(test)', function(obj){
		    var checkStatus = table.checkStatus(obj.config.id);
		    switch(obj.event){
		      case 'getCheckData':
		        var data = checkStatus.data;
		        layer.alert(JSON.stringify(data));
		      break;
		      case 'getCheckLength':
		        var data = checkStatus.data;
		        layer.msg('选中了：'+ data.length + ' 个');
		      break;
		      case 'isAll':
		        layer.msg(checkStatus.isAll ? '全选': '未全选');
		      break;
		      
		      //自定义头工具栏右侧图标 - 提示
		      case 'LAYTABLE_TIPS':
		        layer.alert('这是工具栏右侧自定义的一个图标按钮');
		      break;
		    };
		  });
		  
		  //监听行工具事件
		  table.on('tool(test)', function(obj){
		    var data = obj.data;
		    //console.log(obj)
		    if(obj.event === 'del'){
		      layer.confirm('真的删除行么', function(index){
		        obj.del();
		        layer.close(index);
		      });
		    } else if(obj.event === 'edit'){
		      layer.prompt({
		        formType: 2
		        ,value: data.email
		      }, function(value, index){
		        obj.update({
		          email: value
		        });
		        layer.close(index);
		      });
		    }
		  });
		  //上传
			upload.render({
				elem: '#uploadFile',
				auto: false,
				accept: 'file',
				exts: 'xls|xlsx',
				choose: (obj) => {
					let files = obj.pushFile()
					obj.preview((index, file, result) => {
						let fileReader = readWorkbookFromLocalFile(file, (book) => {
							let sheetNames = book.SheetNames; // 工作表名称集合
							let worksheet = book.Sheets[sheetNames[0]]
							window.importListJson = XLSX.utils.sheet_to_json(worksheet)
							layer.open({
								type: 2,
								title: '编辑数据',
								area: ['450px', '500px'],
								btn: ['确认', '取消'],
								id: 'importListIframe',
								yes: (index, layero) => {
									$("#importListIframe iframe")[0].contentWindow.yes()
								},
								btn2: (index, layero) => {
									console.log('取消')
								},
								closeBtn: 0,
								content: '/dialog/importList'
							})
						})
					})
				},
				done: res => {
					console.log(res)
				}
			})
		});

		// 读取本地excel文件
		window.readWorkbookFromLocalFile = (file, callback) => {
			let reader = new FileReader()
			reader.onload = function(e) {
				let data = e.target.result
				let workbook = XLSX.read(data, {type: 'binary'})
				if(callback) callback(workbook)
			};
			reader.readAsBinaryString(file)
			return reader
		}
    </script>
</html>
